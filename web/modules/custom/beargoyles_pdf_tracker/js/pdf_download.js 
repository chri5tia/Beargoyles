(function ($, Drupal) {
  Drupal.behaviors.beargoylesPdfDownload = {
    attach: function (context, settings) {
      console.log("‚úÖ Beargoyles PDF Download JavaScript behavior attached!");

      $('.pdf-download-button', context).once('pdfDownload').each(function () {
        console.log("‚úÖ Found a PDF download button!");

        $(this).click(function (event) {
          event.preventDefault(); // Prevent default behavior

          var nid = $(this).data('nid');
          console.log("üñ±Ô∏è Download button clicked. NID:", nid);

          // Ensure we have a valid node ID before making the AJAX call
          if (!nid) {
            console.error("‚ùå No NID found on button!");
            alert('Error: No valid PDF found.');
            return;
          }

          $.ajax({
            url: '/generate-download-link/' + nid,
            type: 'GET',
            dataType: 'json',
            success: function (response) {
              console.log("üîÑ AJAX response received:", response);

              if (response.url) {
                console.log("üîó Redirecting to:", response.url);
                window.location.href = response.url;
              } else {
                console.error("‚ùå Failed to generate PDF link.");
                alert('Failed to generate PDF link.');
              }
            },
            error: function (xhr, status, error) {
              console.error("‚ùå AJAX request failed:", status, error);
              alert('An error occurred while trying to generate the download link.');
            }
          });
        });
      });
    }
  };
})(jQuery, Drupal);
